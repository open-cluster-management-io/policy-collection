# This policy creates a namespace based backup using Triliovault for Kubernetes (TVK)
# on all OpenShift managed clusters with a label "protected-by=triliovault".
#
# To create the namespace backup, following process is followed
# 1. Create the target object to store backup data
#    This policy creates AWS S3 based target storage for storing backup images. 
# 2. Create a backup plan that references the following:
#      Namespace to be backed up 
#      Default Scheduling Policy - create daily 1 backup
#      Target to where the data should be backed up
# 3. Apply the Backup CR that references the Backup
#    This policy creates a full backup.
#
# IMPORTANT: Please replace below values for the poliy to work
# 1. Namespace "test" - replace with namespace for which backup to be created
#      Replace all the occurences of "test"
# 2. AWS S3 details for target creation
#      accessKey - line no. 66
#      secretKey - line no. 67
#      bucketName - line no. 88
#      region - line no. 89

apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: create-tvk-backup
  namespace: default
  annotations:
    policy.open-cluster-management.io/categories: CA Security Assessment and Authorization
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/controls: CA-2 Security Assessments, CA-7 Continuous Monitoring
spec:
  disabled: false
  remediationAction: enforce
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: tvk-backup-ns
        spec:
          remediationAction: inform
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Namespace
                metadata:
                  name: test
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: tvk-s3-secret
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Secret
                metadata:
                  name: tvk-s3-secret
                  namespace: default
                type: Opaque
                stringData:
                  accessKey: "PROVIDE_ACCESS_KEY"
                  secretKey: "PROVIDE_SECRET_KEY"
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: tvk-s3-target-test
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: triliovault.trilio.io/v1
                kind: Target
                metadata:
                  name: tvk-s3-target
                  namespace: test
                spec:
                  type: ObjectStore
                  vendor: AWS
                  objectStoreCredentials:
                    bucketName: "PROVIDE_BUCKET_NAME"
                    region: "PROVIDE_REGION_NAME"
                    credentialSecret:
                      name: tvk-s3-secret
                      namespace: default
                  thresholdCapacity: 100Gi
                status:
                  status: Available
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: tvk-backupplan
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: triliovault.trilio.io/v1
                kind: BackupPlan
                metadata:
                  name: test-backupplan
                  namespace: test
                spec:
                  backupNamespace: test
                  backupConfig:
                    target:
                      name: tvk-s3-target
                      namespace: test
                    schedulePolicy:
                      fullBackupPolicy:
                        name: trilio-daily-schedule-policy
                        namespace: default
                  backupPlanFlags:
                    skipImageBackup: true
                  retainHelmApps: false
                status:
                  status: Available
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: tvk-backup
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: triliovault.trilio.io/v1
                kind: Backup
                metadata:
                  name: test-full-backup
                  namespace: test
                spec:
                  type: Full
                  backupPlan:
                    name: test-backupplan
                    namespace: test
                status: 
                  status: Available
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: tvk-backup-placement
  namespace: default
spec:
  clusterSelector:
    matchExpressions:
      - key: protected-by
        operator: In
        values:
          - triliovault
      - key: vendor
        operator: In
        values:
          - OpenShift
  clusterConditions:
    - status: "True"
      type: ManagedClusterConditionAvailable
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: tvk-backup-placement
  namespace: default
placementRef:
  name: tvk-backup-placement
  apiGroup: apps.open-cluster-management.io
  kind: PlacementRule
subjects:
  - name: create-tvk-backup
    apiGroup: policy.open-cluster-management.io
    kind: Policy

