apiVersion: policy.open-cluster-management.io/v1
kind: ConfigurationPolicy
metadata:
  name: policy-odf-cluster
spec:
  remediationAction: enforce
  severity: high
  object-templates-raw: |
    {{- /* create the StorageClass if on VMware */ -}}
    {{- if (eq (lookup "config.openshift.io/v1" "Infrastructure" "" "cluster").spec.platformSpec.type "VSphere") }}
    - complianceType: musthave
      objectDefinition:
        apiVersion: storage.k8s.io/v1
        kind: StorageClass
        metadata:
          annotations:
            storageclass.kubernetes.io/is-default-class: "false"
          name: thin-csi-odf
        parameters:
          StoragePolicyName: "vSAN Default Storage Policy"
        provisioner: csi.vsphere.vmware.com
        allowVolumeExpansion: true
        reclaimPolicy: Delete
        volumeBindingMode: WaitForFirstConsumer
    {{- end }}
    - complianceType: musthave
      objectDefinition:
        apiVersion: ocs.openshift.io/v1
        kind: StorageCluster
        metadata:
          name: ocs-storagecluster
          namespace: openshift-storage
        spec:
          arbiter: {}
          encryption:
            kms: {}
          externalStorage: {}
          managedResources:
            cephBlockPools: {}
            cephCluster: {}
            cephConfig: {}
            cephDashboard: {}
            cephFilesystems: {}
            cephNonResilientPools: {}
            cephObjectStoreUsers: {}
            cephObjectStores: {}
            cephRBDMirror: {}
            cephToolbox: {}
          multiCloudGateway:
    {{- if (eq (lookup "config.openshift.io/v1" "Infrastructure" "" "cluster").spec.platformSpec.type "VSphere") }}
            dbStorageClassName: thin-csi-odf
    {{- else }}
            dbStorageClassName: gp3-csi
    {{- end }}
            reconcileStrategy: standalone
          resourceProfile: balanced
